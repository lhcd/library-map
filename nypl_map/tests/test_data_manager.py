from django.test import TestCase

from nypl_map.models import Library, Alert, Hour, Location
from nypl_map.library_updater.data_manager import DataManager

class DataManagerTestCase(TestCase):
    def test_dataset_update(self):
        data_manager = DataManager()
        data_manager.update_dataset(MICRO_DATASET)

        self.assertEqual(Library.objects.all().count(), 2)
        self.assertEqual(Location.objects.all().count(), 2)
        self.assertEqual(Hour.objects.all().count(), 14)
        self.assertEqual(Alert.objects.all().count(), 1)


MICRO_DATASET = {'locations': [{'_links': {'self': {'href': 'https://refinery.nypl.org/api/nypl/locations/v1.0/locations/115th-street', 'about': 'https://www.nypl.org/about/locations/115th-street'}, 'blogs': {'href': 'https://refinery.nypl.org/api/nypl/locations/v1.0/locations/115th-street/blogs', 'all': 'https://www.nypl.org/blog/library/1'}, 'events': {'href': 'https://refinery.nypl.org/api/nypl/locations/v1.0/locations/115th-street/events', 'all': 'https://www.nypl.org/events/calendar?location=1'}, 'exhibitions': {'href': 'https://refinery.nypl.org/api/nypl/locations/v1.0/locations/115th-street/exhibitions'}, 'alerts': {'href': 'https://refinery.nypl.org/api/nypl/locations/v1.0/locations/115th-street/alerts'}, 'on_shelves': {'href': 'https://browse.nypl.org'}, 'amenities': {'href': 'https://refinery.nypl.org/api/nypl/locations/v1.0/locations/115th-street/amenities'}, 'contact': {'href': 'http://www.questionpoint.org/crs/servlet/org.oclc.admin.BuildForm?&institution=10208&type=1&language=1'}, 'concierge': {'href': ''}, 'projects': {'href': 'https://atlas.nypl.org/locations/115th-street'}}, 'about': 'The 115th Street branch of The New York Public Library opened on November 6, 1908 and was built with funds donated by Andrew Carnegie. Over the past century, the library has evolved into a focal point of community activity, learning, and artistic production. In 2017, the branch adopted its new name in honor of civil rights leader and entertainer Harry Belafonte.', 'access': 'Fully Accessible', 'accessibility_note': '', 'contacts': {'phone': '(212) 666-9393', 'manager': {'fn': 'Tequila Davis', 'title': 'Library Manager'}}, 'cross_street': '', 'floor': '', 'fundraising': {'id': 275290, 'statement': 'Friends of the Library can support their favorite library and receive great benefits!', 'appeal': 'Become a Member', 'button_label': 'Join or Renew', 'link': 'https://secure.nypl.org/site/Donation2?7823.donation=form1&df_id=7823&mfc_pref=T&s_src=FRQXXZZ_QWLP'}, 'geolocation': {'type': 'Point', 'coordinates': [-73.9532, 40.8028]}, 'hours': {'regular': [{'day': 'Sun.', 'open': None, 'close': None}, {'day': 'Mon.', 'open': '11:00', 'close': '19:00'}, {'day': 'Tue.', 'open': '11:00', 'close': '19:00'}, {'day': 'Wed.', 'open': '11:00', 'close': '19:00'}, {'day': 'Thu.', 'open': '11:00', 'close': '19:00'}, {'day': 'Fri.', 'open': '10:00', 'close': '17:00'}, {'day': 'Sat.', 'open': '10:00', 'close': '17:00'}]}, 'id': 'HU', 'images': {'exterior': 'https://www.nypl.org/sites/default/files/images/locations/1/exterior_115-6792.jpg', 'interior': 'https://www.nypl.org/sites/default/files/images/locations/1/interior_115-6949_0.jpg'}, 'locality': 'New York', 'name': 'Harry Belafonte 115th Street Library', 'open': True, 'postal_code': '10026', 'region': 'NY', 'slug': '115th-street', 'social_media': [{'site': 'facebook', 'href': 'http://www.facebook.com/pages/115th-Street-Branch/105612772837483'}, {'site': 'twitter', 'href': 'https://twitter.com/BelafonteNYPL'}, {'site': 'foursquare', 'href': 'http://foursquare.com/venue/1029658'}, {'site': 'youtube', 'href': 'http://www.youtube.com/NewYorkPublicLibrary'}], 'street_address': '203 West 115th Street', 'synonyms': ['115th Street ', ' Belafonte Library'], 'terms': [], 'type': 'circulating', '_embedded': {'amenities': [{'location_rank': 1, 'accessibility_note': '', 'accessible': True, 'staff_assistance': False, 'amenity': {'_links': {'self': {'href': None}, 'action': {'name': 'Reserve a PC', 'href': 'http://pcreserve.nypl.org/'}, 'info': {'name': '', 'href': 'https://www.nypl.org/help/computers-internet-and-wireless-access/reserving-computer'}}, 'category': 'Computer Services', 'id': 7964, 'name': 'Computers for public use', 'rank': 1}}, {'location_rank': 3, 'accessibility_note': '', 'accessible': True, 'staff_assistance': False, 'amenity': {'_links': {'self': {'href': None}, 'info': {'name': 'Learn more', 'href': 'https://www.nypl.org/help/computers-internet-and-wireless-access/wireless-internet-access'}}, 'category': 'Computer Services', 'id': 7967, 'name': 'Wireless internet access (Wi-Fi)', 'rank': 2}}, {'location_rank': 5, 'accessibility_note': '', 'accessible': True, 'staff_assistance': False, 'amenity': {'_links': {'self': {'href': None}, 'info': {'name': '', 'href': 'https://www.nypl.org/about/locations/using-the-library/research-center-onsite-copies'}}, 'category': 'Printing and Copy Services', 'id': 7975, 'name': 'Photocopiers (black/white)', 'rank': 5}}, {'location_rank': 7, 'accessibility_note': '', 'accessible': True, 'staff_assistance': False, 'amenity': {'_links': {'self': {'href': None}}, 'category': 'Facilities', 'id': 7981, 'name': "Children's only restrooms", 'rank': 8}}, {'location_rank': 2, 'accessibility_note': '', 'accessible': True, 'staff_assistance': False, 'amenity': {'_links': {'self': {'href': None}, 'info': {'name': 'Learn more', 'href': 'https://www.nypl.org/help/computers-internet-and-wireless-access/reserving-computer'}}, 'category': 'Computer Services', 'id': 7966, 'name': 'Printers (black/white)', 'rank': 11}}, {'location_rank': 6, 'accessibility_note': '', 'accessible': True, 'staff_assistance': False, 'amenity': {'_links': {'self': {'href': None}}, 'category': 'Facilities', 'id': 7980, 'name': 'Public restrooms', 'rank': 14}}, {'location_rank': 4, 'accessibility_note': '', 'accessible': True, 'staff_assistance': False, 'amenity': {'_links': {'self': {'href': None}, 'info': {'name': 'Learn more', 'href': 'https://www.nypl.org/help/research-services/interlibrary-loan'}}, 'category': 'Circulation', 'id': 7969, 'name': 'Interlibrary loan', 'rank': 16}}, {'location_rank': 10, 'accessibility_note': '', 'accessible': True, 'staff_assistance': False, 'amenity': {'_links': {'self': {'href': None}, 'info': {'name': 'Learn more', 'href': 'https://www.nypl.org/help/community-outreach/services-for-persons-with-disabilities/assistive-technologies/software'}}, 'category': 'Assistive Technologies', 'id': 7990, 'name': 'Screen magnification software (MAGic)', 'rank': 17}}, {'location_rank': 9, 'accessibility_note': '', 'accessible': True, 'staff_assistance': False, 'amenity': {'_links': {'self': {'href': None}, 'info': {'name': 'Learn more', 'href': 'https://www.nypl.org/help/community-outreach/services-for-persons-with-disabilities/assistive-technologies/software'}}, 'category': 'Assistive Technologies', 'id': 7991, 'name': 'Screen reading software (JAWS)', 'rank': 18}}, {'location_rank': 8, 'accessibility_note': '', 'accessible': True, 'staff_assistance': False, 'amenity': {'_links': {'self': {'href': None}}, 'category': 'Facilities', 'id': 7989, 'name': 'Water fountain', 'rank': 99999}}], 'alerts': []}}, {'_links': {'self': {'href': 'https://refinery.nypl.org/api/nypl/locations/v1.0/locations/125th-street', 'about': 'https://www.nypl.org/about/locations/125th-street'}, 'blogs': {'href': 'https://refinery.nypl.org/api/nypl/locations/v1.0/locations/125th-street/blogs', 'all': 'https://www.nypl.org/blog/library/2'}, 'events': {'href': 'https://refinery.nypl.org/api/nypl/locations/v1.0/locations/125th-street/events', 'all': 'https://www.nypl.org/events/calendar?location=2'}, 'exhibitions': {'href': 'https://refinery.nypl.org/api/nypl/locations/v1.0/locations/125th-street/exhibitions'}, 'alerts': {'href': 'https://refinery.nypl.org/api/nypl/locations/v1.0/locations/125th-street/alerts'}, 'on_shelves': {'href': 'https://browse.nypl.org'}, 'amenities': {'href': 'https://refinery.nypl.org/api/nypl/locations/v1.0/locations/125th-street/amenities'}, 'contact': {'href': 'http://www.questionpoint.org/crs/servlet/org.oclc.admin.BuildForm?&institution=10208&type=1&language=1'}, 'concierge': {'href': ''}, 'projects': {'href': 'https://atlas.nypl.org/locations/125th-street'}}, 'about': 'The 125th Street branch of The New York Public Library has served East Harlem since 1904. Reflecting the cultural diversity of the neighborhood, the library now offers books and magazines in English and Spanish and a strong African-American heritage collection.\r\n', 'access': 'Partially Accessible', 'accessibility_note': '', 'contacts': {'phone': '(212) 534-5050', 'manager': {'fn': 'Velma Morton', 'title': 'Library Manager'}}, 'cross_street': 'near Third Ave.', 'floor': '', 'fundraising': {'id': 275290, 'statement': 'Friends of the Library can support their favorite library and receive great benefits!', 'appeal': 'Become a Member', 'button_label': 'Join or Renew', 'link': 'https://secure.nypl.org/site/Donation2?7823.donation=form1&df_id=7823&mfc_pref=T&s_src=FRQXXZZ_QWLP'}, 'geolocation': {'type': 'Point', 'coordinates': [-73.9354, 40.8034]}, 'hours': {'regular': [{'day': 'Sun.', 'open': None, 'close': None}, {'day': 'Mon.', 'open': '11:00', 'close': '19:00'}, {'day': 'Tue.', 'open': '11:00', 'close': '19:00'}, {'day': 'Wed.', 'open': '11:00', 'close': '19:00'}, {'day': 'Thu.', 'open': '11:00', 'close': '19:00'}, {'day': 'Fri.', 'open': '10:00', 'close': '17:00'}, {'day': 'Sat.', 'open': '10:00', 'close': '17:00'}]}, 'id': 'HD', 'images': {'exterior': 'https://www.nypl.org/sites/default/files/images/locations/2/exteriors_125th-0186.jpg', 'interior': 'https://www.nypl.org/sites/default/files/images/locations/2/interior_125th_201410202.jpg'}, 'locality': 'New York', 'name': '125th Street Library', 'open': True, 'postal_code': '10035', 'region': 'NY', 'slug': '125th-street', 'social_media': [{'site': 'facebook', 'href': 'http://www.facebook.com/pages/125th-Street-Branch-Library-The-New-York-Public-Library-NYPL/368170331680'}, {'site': 'twitter', 'href': 'https://twitter.com/125thStreetNYPL'}, {'site': 'foursquare', 'href': 'http://foursquare.com/venue/13306678'}, {'site': 'youtube', 'href': 'http://www.youtube.com/NewYorkPublicLibrary'}], 'street_address': '224 East 125th Street', 'synonyms': [], 'terms': [], 'type': 'circulating', '_embedded': {'amenities': [{'location_rank': 2, 'accessibility_note': '', 'accessible': True, 'staff_assistance': False, 'amenity': {'_links': {'self': {'href': None}, 'action': {'name': 'Reserve a PC', 'href': 'http://pcreserve.nypl.org/'}, 'info': {'name': '', 'href': 'https://www.nypl.org/help/computers-internet-and-wireless-access/reserving-computer'}}, 'category': 'Computer Services', 'id': 7964, 'name': 'Computers for public use', 'rank': 1}}, {'location_rank': 1, 'accessibility_note': '', 'accessible': True, 'staff_assistance': False, 'amenity': {'_links': {'self': {'href': None}, 'info': {'name': 'Learn more', 'href': 'https://www.nypl.org/help/computers-internet-and-wireless-access/wireless-internet-access'}}, 'category': 'Computer Services', 'id': 7967, 'name': 'Wireless internet access (Wi-Fi)', 'rank': 2}}, {'location_rank': 5, 'accessibility_note': '', 'accessible': True, 'staff_assistance': False, 'amenity': {'_links': {'self': {'href': None}, 'info': {'name': '', 'href': 'https://www.nypl.org/about/locations/using-the-library/research-center-onsite-copies'}}, 'category': 'Printing and Copy Services', 'id': 7975, 'name': 'Photocopiers (black/white)', 'rank': 5}}, {'location_rank': 11, 'accessibility_note': '', 'accessible': True, 'staff_assistance': False, 'amenity': {'_links': {'self': {'href': None}}, 'category': 'Printing and Copy Services', 'id': 7977, 'name': 'Scanners', 'rank': 7}}, {'location_rank': 4, 'accessibility_note': '', 'accessible': True, 'staff_assistance': False, 'amenity': {'_links': {'self': {'href': None}, 'info': {'name': 'Learn more', 'href': 'https://www.nypl.org/help/computers-internet-and-wireless-access/reserving-computer'}}, 'category': 'Computer Services', 'id': 7966, 'name': 'Printers (black/white)', 'rank': 11}}, {'location_rank': 10, 'accessibility_note': '', 'accessible': True, 'staff_assistance': False, 'amenity': {'_links': {'self': {'href': None}, 'info': {'name': 'Learn more', 'href': 'https://www.nypl.org/help/research-services/interlibrary-loan'}}, 'category': 'Circulation', 'id': 7969, 'name': 'Interlibrary loan', 'rank': 16}}, {'location_rank': 8, 'accessibility_note': '', 'accessible': True, 'staff_assistance': False, 'amenity': {'_links': {'self': {'href': None}, 'info': {'name': 'Learn more', 'href': 'https://www.nypl.org/help/community-outreach/services-for-persons-with-disabilities/assistive-technologies/software'}}, 'category': 'Assistive Technologies', 'id': 7990, 'name': 'Screen magnification software (MAGic)', 'rank': 17}}, {'location_rank': 9, 'accessibility_note': '', 'accessible': True, 'staff_assistance': False, 'amenity': {'_links': {'self': {'href': None}, 'info': {'name': 'Learn more', 'href': 'https://www.nypl.org/help/community-outreach/services-for-persons-with-disabilities/assistive-technologies/software'}}, 'category': 'Assistive Technologies', 'id': 7991, 'name': 'Screen reading software (JAWS)', 'rank': 18}}, {'location_rank': 3, 'accessibility_note': '', 'accessible': True, 'staff_assistance': False, 'amenity': {'_links': {'self': {'href': None}}, 'category': 'Computer Services', 'id': 7965, 'name': 'Laptops for public use', 'rank': 20}}, {'location_rank': 7, 'accessibility_note': '', 'accessible': True, 'staff_assistance': False, 'amenity': {'_links': {'self': {'href': None}}, 'category': 'Circulation', 'id': 7972, 'name': 'Book drop box (limited hours)', 'rank': 21}}, {'location_rank': 6, 'accessibility_note': '', 'accessible': True, 'staff_assistance': False, 'amenity': {'_links': {'self': {'href': None}}, 'category': 'Computer Services', 'id': 7968, 'name': 'Electric outlets available', 'rank': 33}}], 'alerts': [{"id": "562404","scope": "location","_links": {"web": {"href": "https://www.nypl.org/node/562404"}},"msg": "<p>67th Street Library will have a delayed opening on Tuesday, Feb. 4, due to fire alarm testing.\u00a0 We will open at 1:00pm.</p>\n","display": {"start": "2020-02-01T14:00:00-05:00","end": "2020-02-04T13:00:00-05:00"},"closed_for": "fire alarm testing","applies": {"start": "2020-02-04T10:00:00-05:00","end": "2020-02-04T13:00:00-05:00"}
}]}}], 'meta': {'notices': {'cache': {'last-refresh': '2020-02-03T21:45:25-05:00'}}, 'count': 92}}
